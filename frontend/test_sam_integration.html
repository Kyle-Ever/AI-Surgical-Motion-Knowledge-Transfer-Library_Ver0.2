<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>SAM Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        .upload-section {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .canvas-container {
            border: 2px solid #ddd;
            display: inline-block;
            margin: 10px 0;
            border-radius: 4px;
            overflow: hidden;
        }
        canvas {
            cursor: crosshair;
            display: block;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #2563eb; }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .mode-buttons {
            margin: 10px 0;
        }
        .mode-button {
            background: #e5e7eb;
            color: #374151;
        }
        .mode-button.active {
            background: #3b82f6;
            color: white;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #e3f2fd;
            color: #1565c0;
        }
        .error {
            background: #ffebee;
            color: #c62828;
        }
        .success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .instruments-list {
            margin-top: 20px;
            padding: 15px;
            background: #f3f4f6;
            border-radius: 4px;
        }
        .instrument-item {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #visualizationCanvas {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔬 SAM Integration Test - 手術器具セグメンテーション</h1>

        <div class="upload-section">
            <h2>1. 動画アップロード</h2>
            <input type="file" id="videoFile" accept="video/mp4">
            <button onclick="uploadVideo()">アップロード</button>
            <div id="uploadStatus" class="status" style="display:none;"></div>
        </div>

        <div id="segmentationSection" style="display:none;">
            <h2>2. 器具セグメンテーション</h2>

            <div class="mode-buttons">
                <button class="mode-button active" onclick="setMode('point')">
                    📍 ポイント選択
                </button>
                <button class="mode-button" onclick="setMode('box')">
                    ⬜ ボックス選択
                </button>
                <button onclick="resetSelection()">🔄 リセット</button>
            </div>

            <div>
                <div class="canvas-container">
                    <canvas id="thumbnailCanvas" width="640" height="480"></canvas>
                </div>
                <div class="canvas-container">
                    <canvas id="visualizationCanvas" width="640" height="480"></canvas>
                </div>
            </div>

            <div>
                <button onclick="performSegmentation()" id="segmentBtn">
                    セグメント実行
                </button>
                <input type="text" id="instrumentName" placeholder="器具名を入力" style="padding: 8px; margin: 0 10px;">
                <button onclick="addInstrument()" id="addBtn" disabled>
                    器具を追加
                </button>
            </div>

            <div id="segmentStatus" class="status" style="display:none;"></div>
        </div>

        <div id="instrumentsList" class="instruments-list" style="display:none;">
            <h3>登録された器具</h3>
            <div id="instrumentsContent"></div>
            <button onclick="registerInstruments()" style="margin-top: 10px;">
                器具を登録
            </button>
        </div>
    </div>

    <script>
        let currentVideoId = null;
        let selectionMode = 'point';
        let points = [];
        let box = null;
        let dragStart = null;
        let currentMask = null;
        let instruments = [];

        const canvas = document.getElementById('thumbnailCanvas');
        const ctx = canvas.getContext('2d');
        const visCanvas = document.getElementById('visualizationCanvas');
        const visCtx = visCanvas.getContext('2d');

        // Canvas event handlers
        canvas.addEventListener('click', handleCanvasClick);
        canvas.addEventListener('mousedown', handleMouseDown);
        canvas.addEventListener('mousemove', handleMouseMove);
        canvas.addEventListener('mouseup', handleMouseUp);

        function setMode(mode) {
            selectionMode = mode;
            document.querySelectorAll('.mode-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            resetSelection();
        }

        function resetSelection() {
            points = [];
            box = null;
            currentMask = null;
            redrawCanvas();
            visCtx.clearRect(0, 0, visCanvas.width, visCanvas.height);
        }

        function handleCanvasClick(e) {
            if (selectionMode !== 'point') return;

            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);

            const label = e.shiftKey ? 0 : 1; // Shift+click for background
            points.push({x, y, label});

            redrawCanvas();
        }

        function handleMouseDown(e) {
            if (selectionMode !== 'box') return;

            const rect = canvas.getBoundingClientRect();
            dragStart = {
                x: (e.clientX - rect.left) * (canvas.width / rect.width),
                y: (e.clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function handleMouseMove(e) {
            if (!dragStart || selectionMode !== 'box') return;

            const rect = canvas.getBoundingClientRect();
            const currentX = (e.clientX - rect.left) * (canvas.width / rect.width);
            const currentY = (e.clientY - rect.top) * (canvas.height / rect.height);

            box = [
                Math.min(dragStart.x, currentX),
                Math.min(dragStart.y, currentY),
                Math.max(dragStart.x, currentX),
                Math.max(dragStart.y, currentY)
            ];

            redrawCanvas();
        }

        function handleMouseUp() {
            dragStart = null;
        }

        function redrawCanvas() {
            // Draw points
            points.forEach(point => {
                ctx.beginPath();
                ctx.arc(point.x, point.y, 5, 0, 2 * Math.PI);
                ctx.fillStyle = point.label === 1 ? '#22c55e' : '#ef4444';
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
            });

            // Draw box
            if (box) {
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 2;
                ctx.strokeRect(box[0], box[1], box[2] - box[0], box[3] - box[1]);
            }
        }

        async function uploadVideo() {
            const fileInput = document.getElementById('videoFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('動画ファイルを選択してください');
                return;
            }

            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = 'status';
            statusDiv.textContent = 'アップロード中...';

            const formData = new FormData();
            formData.append('file', file);
            formData.append('video_type', 'internal');
            formData.append('surgery_name', 'SAM Test');

            try {
                const response = await fetch('http://localhost:8000/api/v1/videos/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Upload failed');

                const data = await response.json();
                currentVideoId = data.video_id;

                statusDiv.className = 'status success';
                statusDiv.textContent = `✅ アップロード成功: ${data.video_id}`;

                // Load thumbnail
                await loadThumbnail();

                document.getElementById('segmentationSection').style.display = 'block';

            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `❌ エラー: ${error.message}`;
            }
        }

        async function loadThumbnail() {
            try {
                const response = await fetch(`http://localhost:8000/api/v1/videos/${currentVideoId}/thumbnail`);
                if (!response.ok) throw new Error('Failed to load thumbnail');

                const blob = await response.blob();
                const img = new Image();
                img.onload = () => {
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                };
                img.src = URL.createObjectURL(blob);

            } catch (error) {
                console.error('Thumbnail error:', error);
            }
        }

        async function performSegmentation() {
            if (!currentVideoId) return;

            const statusDiv = document.getElementById('segmentStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = 'status';
            statusDiv.textContent = 'セグメント中...';

            const requestBody = {
                prompt_type: selectionMode,
                frame_number: 0
            };

            if (selectionMode === 'point') {
                if (points.length === 0) {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '❌ ポイントを選択してください';
                    return;
                }
                requestBody.coordinates = points.map(p => [p.x, p.y]);
                requestBody.labels = points.map(p => p.label);
            } else {
                if (!box) {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '❌ ボックスを描画してください';
                    return;
                }
                requestBody.coordinates = [box];
            }

            try {
                const response = await fetch(`http://localhost:8000/api/v1/videos/${currentVideoId}/segment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) throw new Error('Segmentation failed');

                const result = await response.json();
                currentMask = result.mask;

                // Display visualization
                if (result.visualization) {
                    const img = new Image();
                    img.onload = () => {
                        visCtx.drawImage(img, 0, 0, visCanvas.width, visCanvas.height);
                    };
                    img.src = `data:image/jpeg;base64,${result.visualization}`;
                }

                statusDiv.className = 'status success';
                statusDiv.textContent = `✅ セグメント成功 - Score: ${result.score.toFixed(3)}, Area: ${result.area} pixels`;

                document.getElementById('addBtn').disabled = false;

            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `❌ エラー: ${error.message}`;
            }
        }

        function addInstrument() {
            const nameInput = document.getElementById('instrumentName');
            const name = nameInput.value.trim();

            if (!name || !currentMask) return;

            instruments.push({
                name: name,
                mask: currentMask,
                bbox: box || [0, 0, 100, 100],
                frame_number: 0
            });

            updateInstrumentsList();
            nameInput.value = '';
            resetSelection();
            document.getElementById('addBtn').disabled = true;
        }

        function updateInstrumentsList() {
            if (instruments.length === 0) {
                document.getElementById('instrumentsList').style.display = 'none';
                return;
            }

            document.getElementById('instrumentsList').style.display = 'block';
            const content = document.getElementById('instrumentsContent');
            content.innerHTML = instruments.map((inst, idx) => `
                <div class="instrument-item">
                    <span>${inst.name}</span>
                    <button onclick="removeInstrument(${idx})" style="background: #ef4444;">削除</button>
                </div>
            `).join('');
        }

        function removeInstrument(index) {
            instruments.splice(index, 1);
            updateInstrumentsList();
        }

        async function registerInstruments() {
            if (!currentVideoId || instruments.length === 0) return;

            try {
                const response = await fetch(`http://localhost:8000/api/v1/videos/${currentVideoId}/instruments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instruments: instruments })
                });

                if (!response.ok) throw new Error('Registration failed');

                const result = await response.json();
                alert(`✅ ${result.instruments_count}個の器具が登録されました！`);

            } catch (error) {
                alert(`❌ エラー: ${error.message}`);
            }
        }
    </script>
</body>
</html>