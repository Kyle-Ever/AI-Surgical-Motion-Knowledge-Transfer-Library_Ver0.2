# AI手技モーションライブラリ 要件定義書

## 1. プロジェクト概要

### 1.1 目的
医療・獣医療における手術手技をデータ化し、指導医の技術を学生・研修医に効果的に伝承するためのWebアプリケーションの開発

### 1.2 主要機能
- 手術動画の解析による手技のデータ化
- 手術器具と手の動きの追跡・記録
- 解析データの可視化とエクスポート
- 手技ライブラリの構築
- 学習者の手技評価と改善提案（フェーズ2）

## 2. システム要件

### 2.1 機能要件

#### フェーズ1（MVP）- 必須機能

##### F1-1: 動画アップロード機能
- **対応形式**: MP4
- **解像度**: FHD (1920x1080)
- **フレームレート**: 30fps対応
- **動画長**: 最大1時間（初期は短時間動画でテスト）
- **映像タイプ選択**: 
  - 体内カメラ映像（腹腔鏡等）
  - 外部カメラ映像（手元撮影）

##### F1-2: 手術器具の検出・追跡
- **事前学習機能**:
  - 動画から静止画を抽出
  - ユーザーによる手動アノテーション（バウンディングボックス）
  - 器具の学習と認識モデルの生成
- **追跡対象**:
  - 体内映像: 器具先端のみ
  - 外部映像: 器具全体

##### F1-3: 手の骨格検出・追跡
- **対象**: 外部カメラ映像の場合のみ
- **追跡**: 両手同時追跡
- **検出項目**: 
  - 手の位置座標
  - 関節角度
  - 移動速度

##### F1-4: データ可視化
- **グラフ表示**:
  - 時系列での座標変化
  - 速度変化
  - 軌跡の2D/3D表示
- **解析済み動画表示**:
  - 元動画にオーバーレイで検出結果表示
  - 骨格・器具のトラッキング可視化

##### F1-5: データエクスポート
- **形式**: Excel (CSV)
- **内容**:
  - タイムスタンプ
  - 座標データ (X, Y, Z)
  - 速度・加速度
  - 角度情報

#### フェーズ2（拡張機能）

##### F2-1: 練習モード
- 学習者の手技動画アップロード
- 指導医の手技との比較分析
- 同一フェーズの自動対応付け
- 統計的差異の算出

##### F2-2: AIフィードバック
- GPT/Gemini APIを利用した分析
- 改善点の具体的提案
- スコアリングと評価

### 2.2 非機能要件

#### パフォーマンス
- **処理時間**: 10分動画を10分以内で処理
- **同時処理**: 1動画のみ
- **データ取得頻度**: 
  - 理想: 30fps (毎フレーム)
  - 最小: 5fps (負荷軽減時)

#### データ管理
- **保存期間**: 1年以上
- **プライバシー**: 患者情報を含まない
- **容量**: 動画ファイルの一時保存領域確保

## 3. システム構成

### 3.1 アーキテクチャ

```
┌─────────────────────────────────────┐
│         フロントエンド              │
│    (React/Next.js)                  │
├─────────────────────────────────────┤
│         バックエンド                │
│    (Python FastAPI)                 │
├─────────────────────────────────────┤
│       動画解析エンジン              │
│  (MediaPipe + YOLO/OpenCV)          │
├─────────────────────────────────────┤
│        データストレージ              │
│   (PostgreSQL/SQLite + File)        │
└─────────────────────────────────────┘
```

### 3.2 技術スタック（推奨）

#### バックエンド
- **言語**: Python 3.9+
- **フレームワーク**: FastAPI
- **動画処理**: OpenCV
- **骨格検出**: MediaPipe
- **物体検出**: YOLOv8 or Detectron2
- **データ処理**: NumPy, Pandas

#### フロントエンド
- **フレームワーク**: React (Next.js)
- **UI**: Tailwind CSS + shadcn/ui
- **グラフ**: Chart.js or Recharts
- **状態管理**: Zustand

#### インフラ（ローカル開発）
- **DB**: SQLite (開発) → PostgreSQL (本番)
- **ストレージ**: ローカルファイルシステム

#### デプロイ（MVP）
- **候補1**: Render (無料プラン)
- **候補2**: Railway (無料枠あり)
- **候補3**: ローカルサーバー + ngrok

## 4. 画面構成

### 4.1 画面一覧

1. **ホーム画面**
   - 機能選択メニュー

2. **動画アップロード画面**
   - ファイル選択
   - 映像タイプ選択
   - 器具アノテーション

3. **解析状況画面**
   - プログレスバー
   - 処理状況表示

4. **ダッシュボード**
   - 解析済み動画プレイヤー
   - グラフ表示エリア
   - データテーブル
   - エクスポートボタン

5. **ライブラリ画面**
   - 保存済み解析結果一覧
   - 検索・フィルター機能

## 5. 開発計画

### 5.1 フェーズ1（MVP）スケジュール案

**Week 1-2: 環境構築とプロトタイプ**
- 開発環境セットアップ
- 基本的な動画アップロード機能
- MediaPipe/YOLOの動作確認

**Week 3-4: コア機能実装**
- 器具検出・追跡機能
- 手の骨格検出機能
- データ抽出処理

**Week 5-6: UI/データ可視化**
- ダッシュボード開発
- グラフ表示機能
- Excel出力機能

**Week 7-8: 統合とテスト**
- 全機能の統合
- バグ修正
- デプロイ準備

### 5.2 リスクと対策

| リスク | 対策 |
|--------|------|
| CPU処理の速度問題 | 短い動画でのテスト、処理の最適化 |
| 無料デプロイの制限 | ローカルデモ、または最小構成での公開 |
| 器具認識の精度 | 複数の検出手法の比較検証 |

## 6. 成功基準

### MVP成功指標
- [ ] 5分以内の動画を正常に処理できる
- [ ] 器具の追跡精度80%以上
- [ ] 手の骨格検出が安定して動作
- [ ] データをExcelで出力可能
- [ ] クライアントデモで基本機能が動作

## 8. AI処理仕様

### 8.1 処理フロー
1. **前処理**: 動画メタデータ抽出（5秒）
2. **フレーム抽出**: 5fpsでサンプリング（10秒）
3. **器具検出**: YOLOv8n + テンプレートマッチング（2分）
4. **骨格検出**: MediaPipe Hands（3分）
5. **データ統合**: 座標データ統合・正規化（30秒）
6. **分析**: 速度・角度計算（1分）
7. **可視化**: オーバーレイ動画生成（2分）

### 8.2 検出精度目標
- **器具検出精度**: > 80%（信頼度スコア）
- **骨格検出精度**: > 80%（MediaPipe信頼度）
- **欠損フレーム許容率**: < 20%
- **処理時間**: < 動画時間（10分動画を10分以内）

### 8.3 データ形式
- **座標系**: 正規化座標（-1 to 1）
- **サンプリング**: 5fps（0.2秒間隔）
- **データ保存**: JSON形式
- **エクスポート**: CSV/Excel形式

## 9. データベース設計

### 9.1 主要テーブル
- **videos**: 動画情報（メタデータ）
- **analysis_results**: 解析結果（座標・速度データ）
- **instruments**: 器具情報（アノテーション）
- **technique_library**: 手技ライブラリ
- **comparison_results**: 比較結果（Phase 2）

### 9.2 データ保存方針
- 元動画: ローカルファイルシステム
- 解析済み動画: リアルタイム生成（保存なし）
- 解析データ: JSONファイル + DBメタデータ
- 保存期間: 1年以上

## 10. API設計

### 10.1 主要エンドポイント（優先度順）
1. POST /api/videos/upload - 動画アップロード
2. POST /api/videos/{id}/analyze - 解析開始
3. GET /api/videos/{id}/status - 解析状況確認
4. GET /api/analysis/{id} - 解析結果取得
5. GET /api/analysis/{id}/export - データエクスポート
6. POST /api/library - ライブラリ登録
7. GET /api/library - ライブラリ一覧

### 10.2 通信方式
- REST API (JSON)
- WebSocket (解析進捗通知)
- マルチパートフォームデータ (動画アップロード)