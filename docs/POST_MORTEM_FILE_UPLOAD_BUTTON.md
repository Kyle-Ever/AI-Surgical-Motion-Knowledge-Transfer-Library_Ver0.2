# Post-Mortem: ファイルアップロードボタン障害

## 発生日時
2025-09-26

## 障害概要
アップロードページ（`/upload`）でファイル選択ボタンがクリックできなくなり、ユーザーがファイルをアップロードできない状態になった。

## 影響範囲
- 影響ページ: `/upload`
- 影響機能: ファイル選択機能
- 影響ユーザー: 全ユーザー
- 影響期間: 数時間

## タイムライン
1. 解析結果ダッシュボードの簡略化作業を実施
2. 複数のコンポーネントを修正中に、誤って`upload/page.tsx`も変更
3. ユーザーから「ファイルを選択ボタンが押せない」と報告
4. 調査開始
5. 根本原因を特定し修正

## 根本原因
### 1. コード変更のミス
```tsx
// 変更前（正常）
<button className="...">
  ファイルを選択
</button>

// 変更後（障害）
<span className="...">
  ファイルを選択
</span>
```

### 2. 変更理由
- ダッシュボード簡略化作業中に、誤って無関係なファイルを修正
- `<button>`を`<span>`に変更してしまった
- onClickハンドラーも削除されていた

### 3. 検出が遅れた理由
- E2Eテストはあったが、実際のファイル選択動作まではテストしていなかった
- コードレビューなしで変更が適用された

### 4. ポート3000で問題が継続した理由
- **古いNode.jsプロセスがキャッシュされたコードを実行し続けていた**
- ポート3000: PID 5704が占有、修正前のコード（`<span>`要素）を実行
- ポート3002: 新規プロセスで修正後のコード（`<button>`要素）が正常動作
- Next.jsのホットリロードが正常に機能していなかった

## 修正内容
1. `<span>`要素を`<button>`要素に戻す
2. `onClick={open}`ハンドラーを追加
3. `noClick: true`をdropzoneに設定してイベント競合を防ぐ

## 再発防止策

### 1. 技術的対策
- ✅ 回帰テストの追加（`button-regression.spec.ts`）
- ✅ ボタン要素の型チェックテスト
- ✅ ファイルアップロード動作の統合テスト

### 2. プロセス改善
- 🔄 無関係なファイルの変更を避ける
- 🔄 変更前後でgit diffを確認
- 🔄 重要なUI要素（ボタン、フォーム）の変更は慎重に

### 3. 開発環境の改善
- ⚠️ 古いプロセスの適切な終了（ポート3000の問題）
- ⚠️ サーバー再起動時の確認手順
- ⚠️ コード変更が反映されない場合の対処法：
  ```bash
  # 1. ポート確認
  netstat -ano | findstr :3000

  # 2. プロセス終了
  taskkill /PID <pid> /F

  # 3. キャッシュクリア
  rmdir /s /q frontend/.next

  # 4. 再起動
  npm run dev
  ```

## 学んだ教訓
1. **スコープ管理**: タスクに関係ないファイルは変更しない
2. **要素の重要性**: `<button>`と`<span>`は見た目は似ていても機能が全く異なる
3. **テストの重要性**: UIの基本的な操作は必ずテストでカバーする
4. **デバッグ手法**:
   - ブラウザコンソールでのエラー確認
   - React Developer Toolsでのコンポーネント状態確認
   - シンプルなHTMLでの動作確認

## アクションアイテム
- [x] ボタン要素の修正
- [x] 回帰テストの作成
- [x] ドキュメントの作成
- [ ] チーム内での共有（該当する場合）
- [ ] CIパイプラインへのテスト追加検討

## 参考リンク
- 修正コミット: [該当するコミットハッシュ]
- 関連ファイル:
  - `frontend/app/upload/page.tsx`
  - `frontend/tests/button-regression.spec.ts`