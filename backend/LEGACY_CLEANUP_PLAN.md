# ãƒ¬ã‚¬ã‚·ãƒ¼ã‚³ãƒ¼ãƒ‰å‰Šé™¤ãƒ»ç°¡ç´ åŒ–è¨ˆç”»

## ğŸ¯ ç›®æ¨™
**è¤‡é›‘ãªãƒ¬ã‚¬ã‚·ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’å®Œå…¨å‰Šé™¤ã—ã€V2ã«ä¸€æœ¬åŒ–ã—ã¦ãƒ‡ãƒãƒƒã‚°å¯èƒ½ãªã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹é€ ã«ã™ã‚‹**

---

## ğŸ“‹ ç¾çŠ¶åˆ†æ

### ãƒ¬ã‚¬ã‚·ãƒ¼ã‚³ãƒ¼ãƒ‰ã®å®Ÿæ…‹

#### 1. **æ—§SAM Tracker (`sam_tracker.py`)** ğŸ”´ å‰Šé™¤å¯¾è±¡
- **å ´æ‰€**: `backend/app/ai_engine/processors/sam_tracker.py`
- **ä½¿ç”¨ç®‡æ‰€**:
  - `app/api/routes/analysis.py` (Line 557, 560-598) - `process_with_mediapipe`é–¢æ•°å†…
  - `app/api/routes/videos.py` - å™¨å…·é¸æŠç”¨
- **å•é¡Œ**:
  - `use_mock` ãƒ•ãƒ©ã‚°ã«ã‚ˆã‚‹äºŒé‡å®Ÿè£…
  - OpenCVãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ··åœ¨
  - V2ã®`sam_tracker_unified.py`ã¨æ©Ÿèƒ½é‡è¤‡

#### 2. **æ—§Analysiså‡¦ç† (`analysis.py`å†…)** ğŸ”´ å‰Šé™¤å¯¾è±¡
- **å ´æ‰€**: `app/api/routes/analysis.py` Line 500-700
- **é–¢æ•°**: `process_with_mediapipe()` - å·¨å¤§ãªå‡¦ç†é–¢æ•°
- **å•é¡Œ**:
  - MediaPipeã¨SAMã‚’æ··åœ¨å‡¦ç†
  - ãƒ•ãƒ¬ãƒ¼ãƒ ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ã€å…‰å­¦ãƒ•ãƒ­ãƒ¼ã€è¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯
  - V2ã®`AnalysisServiceV2.analyze_video()`ã¨å®Œå…¨é‡è¤‡

#### 3. **æ•£ä¹±ã—ãŸãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«** ğŸŸ¡ æ•´ç†å¯¾è±¡
- **å ´æ‰€**: `backend/` ãƒ«ãƒ¼ãƒˆç›´ä¸‹ã«18å€‹ã®test_*.py
- **å•é¡Œ**:
  - ä½•ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ä½•ãŒå»ƒæ­¢ã‹ä¸æ˜
  - ãƒ‡ãƒãƒƒã‚°ç”¨ã®ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ®‹ç•™
  - `backend/tests/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚ã‚‹ã®ã«æœªä½¿ç”¨

#### 4. **é‡è¤‡ã—ãŸæ¤œå‡ºå™¨å®Ÿè£…** ğŸ”´ çµ±åˆå¯¾è±¡
- `enhanced_hand_detector.py` - æ”¹è‰¯ç‰ˆ
- `skeleton_detector.py` - æ¨™æº–ç‰ˆ
- ã©ã¡ã‚‰ã‚’ä½¿ã†ã¹ãã‹ä¸æ˜ç¢º

---

## âœ… ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥å®Ÿè¡Œè¨ˆç”»

### **Phase 0: å®‰å…¨ç¢ºèªï¼ˆ15åˆ†ï¼‰**
- [ ] ç¾åœ¨ã®å…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆ
- [ ] ã©ã®ã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¹ãŒå®Ÿéš›ã«ä½¿ã‚ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- [ ] V2ãŒå…¨ã¦ã®æ©Ÿèƒ½ã‚’ã‚«ãƒãƒ¼ã—ã¦ã„ã‚‹ã‹æ¤œè¨¼

**ãƒ†ã‚¹ãƒˆ**:
```bash
# ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
curl -X POST http://localhost:8000/api/v1/videos/upload

# è§£æé–‹å§‹ï¼ˆV2ä½¿ç”¨ç¢ºèªï¼‰
curl -X POST http://localhost:8000/api/v1/analysis/{video_id}/analyze

# å™¨å…·ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
curl -X POST http://localhost:8000/api/v1/instrument-tracking/{video_id}/track
```

---

### **Phase 1: V2ã¸ã®å®Œå…¨ç§»è¡Œç¢ºèªï¼ˆ30åˆ†ï¼‰**

#### 1.1 `analysis.py`ã®æ—§å‡¦ç†ã‚’ç„¡åŠ¹åŒ–
**å¯¾è±¡**: `process_with_mediapipe()` é–¢æ•° (Line 500-700)

**æ‰‹é †**:
1. é–¢æ•°ã®å…ˆé ­ã«æ˜ç¤ºçš„ãªã‚¨ãƒ©ãƒ¼ã‚’è¿½åŠ 
   ```python
   def process_with_mediapipe(...):
       raise NotImplementedError("DEPRECATED: Use AnalysisServiceV2 instead")
   ```
2. ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•
3. è§£æãƒ†ã‚¹ãƒˆå®Ÿè¡Œ â†’ ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„ã“ã¨ã‚’ç¢ºèªï¼ˆV2ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹è¨¼æ‹ ï¼‰
4. ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã‚‰ã€ã¾ã æ—§ã‚³ãƒ¼ãƒ‰ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ â†’ åŸå› èª¿æŸ»

**ãƒ†ã‚¹ãƒˆ**: æ–°ã—ã„å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰â†’è§£æâ†’æˆåŠŸç¢ºèª

#### 1.2 æ—§SAM Trackerã®ä¾å­˜é–¢ä¿‚ã‚’ç¢ºèª
```bash
grep -r "from.*sam_tracker[^_]" backend/app/
```

**ç½®ãæ›ãˆç®‡æ‰€**:
- `analysis.py`: ã™ã§ã«V2ä½¿ç”¨ãªã®ã§ä¸è¦
- `videos.py`: å™¨å…·é¸æŠç”¨ â†’ `sam_tracker_unified`ã«ç½®ãæ›ãˆ

**ãƒ†ã‚¹ãƒˆ**: å™¨å…·é¸æŠæ©Ÿèƒ½ãŒå‹•ä½œã™ã‚‹ã‹ç¢ºèª

---

### **Phase 2: ãƒ¬ã‚¬ã‚·ãƒ¼ã‚³ãƒ¼ãƒ‰å‰Šé™¤ï¼ˆ20åˆ†ï¼‰**

#### 2.1 æ—§SAM Trackerå‰Šé™¤
```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå¿µã®ãŸã‚ï¼‰
cp backend/app/ai_engine/processors/sam_tracker.py backend/sam_tracker.py.bak

# å‰Šé™¤
rm backend/app/ai_engine/processors/sam_tracker.py
```

#### 2.2 `analysis.py`ã‹ã‚‰æ—§å‡¦ç†é–¢æ•°å‰Šé™¤
**å‰Šé™¤å¯¾è±¡**:
- `process_with_mediapipe()` é–¢æ•°å…¨ä½“ (Line 500-700)
- é–¢é€£ã™ã‚‹ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

**ãƒ†ã‚¹ãƒˆ**: ã‚µãƒ¼ãƒãƒ¼èµ·å‹• â†’ ã‚¨ãƒ©ãƒ¼ãªã— â†’ è§£æå®Ÿè¡Œ â†’ æˆåŠŸ

#### 2.3 æœªä½¿ç”¨ã®æ¤œå‡ºå™¨æ•´ç†
**åˆ¤æ–­åŸºæº–**:
- `skeleton_detector.py`: V2ã§ä½¿ç”¨ä¸­ â†’ **ä¿æŒ**
- `enhanced_hand_detector.py`: æœªä½¿ç”¨ï¼Ÿ â†’ èª¿æŸ»å¾Œåˆ¤æ–­

```bash
grep -r "enhanced_hand_detector" backend/app/
```

---

### **Phase 3: ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ•´ç†ï¼ˆ15åˆ†ï¼‰**

#### 3.1 ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ†ã‚¹ãƒˆã‚’ç‰¹å®š
```bash
# æœ€è¿‘å®Ÿè¡Œã•ã‚ŒãŸãƒ†ã‚¹ãƒˆï¼ˆmodification timeã§ã‚½ãƒ¼ãƒˆï¼‰
ls -lt backend/test_*.py | head -10
```

#### 3.2 tests/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ç§»å‹•
```bash
mkdir -p backend/tests/legacy
mv backend/test_*.py backend/tests/legacy/
mv backend/upload_test_video.py backend/tests/legacy/
```

#### 3.3 å¿…è¦ãªãƒ†ã‚¹ãƒˆã®ã¿tests/ã«ç§»å‹•
- `tests/test_integration.py` - æ—¢ã«æ­£ã—ã„å ´æ‰€
- `backend/tests/legacy/test_sam_auto_detect.py` â†’ `tests/test_sam_unified.py`ï¼ˆãƒªãƒãƒ¼ãƒ ï¼‰

**ãƒ†ã‚¹ãƒˆ**: é‡è¦ãªãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒå‹•ä½œã™ã‚‹ã‹ç¢ºèª

---

### **Phase 4: ã‚³ãƒ¼ãƒ‰ã®æœ€çµ‚ç°¡ç´ åŒ–ï¼ˆ20åˆ†ï¼‰**

#### 4.1 importæ–‡ã®æ•´ç†
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**:
- `analysis.py`: æœªä½¿ç”¨ã®importã‚’å‰Šé™¤
- `videos.py`: SAMé–¢é€£ã‚’`sam_tracker_unified`ã«çµ±ä¸€

#### 4.2 ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®çµ±ä¸€
- `[V2]` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å…¨ã¦ `[ANALYSIS]` ã«çµ±ä¸€
- ä¸€è²«æ€§ã®ã‚ã‚‹ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

#### 4.3 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
```markdown
# docs/06_development/code_structure.md
## Analysis Pipeline (Simplified)
1. Upload: POST /api/v1/videos/upload
2. Analyze: POST /api/v1/analysis/{video_id}/analyze
   - Uses: AnalysisServiceV2 ONLY
   - SAM: sam_tracker_unified ONLY
   - Skeleton: skeleton_detector
3. Results: GET /api/v1/analysis/{analysis_id}
```

**ãƒ†ã‚¹ãƒˆ**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨å®Ÿè£…ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèª

---

### **Phase 5: æœ€çµ‚æ¤œè¨¼ï¼ˆ30åˆ†ï¼‰**

#### 5.1 å…¨æ©Ÿèƒ½ã®åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆ
```bash
# E2Eãƒ†ã‚¹ãƒˆ
cd frontend
npm run test tests/e2e-v2-upload.spec.ts
npm run test tests/e2e-v2-analysis-external.spec.ts
npm run test tests/e2e-v2-analysis-internal.spec.ts
```

#### 5.2 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¢ºèª
- è§£æé€Ÿåº¦ãŒé…ããªã£ã¦ã„ãªã„ã‹
- ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãŒãªã„ã‹
- ãƒ­ã‚°ãŒé©åˆ‡ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã‹

#### 5.3 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç¢ºèª
- ç•°å¸¸ãªå…¥åŠ›ã§ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãªã„ã‹
- é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºã‚‹ã‹

---

## ğŸ“Š å‰Šé™¤ãƒ»æ•´ç†äºˆå®šãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ

### ğŸ”´ å®Œå…¨å‰Šé™¤
- [ ] `backend/app/ai_engine/processors/sam_tracker.py`
- [ ] `backend/app/api/routes/analysis.py` ã® `process_with_mediapipe()` é–¢æ•°

### ğŸŸ¡ ç§»å‹•ãƒ»ãƒªãƒãƒ¼ãƒ 
- [ ] `backend/test_*.py` (18ãƒ•ã‚¡ã‚¤ãƒ«) â†’ `backend/tests/legacy/`
- [ ] `backend/upload_test_video.py` â†’ `backend/tests/legacy/`

### ğŸŸ¢ ä¿æŒãƒ»æ›´æ–°
- [x] `backend/app/ai_engine/processors/sam_tracker_unified.py` - ãƒ¡ã‚¤ãƒ³å®Ÿè£…
- [x] `backend/app/services/analysis_service_v2.py` - ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
- [x] `backend/app/ai_engine/processors/skeleton_detector.py` - éª¨æ ¼æ¤œå‡º

### â“ èª¿æŸ»ãŒå¿…è¦
- [ ] `backend/app/ai_engine/processors/enhanced_hand_detector.py` - ä½¿ç”¨çŠ¶æ³ç¢ºèª

---

## ğŸ¯ æˆåŠŸåŸºæº–

### å³åº§ï¼ˆå„Phaseå®Œäº†æ™‚ï¼‰:
- [ ] ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã™ã‚‹ï¼ˆã‚¨ãƒ©ãƒ¼ãªã—ï¼‰
- [ ] æ–°ã—ã„å‹•ç”»ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒæˆåŠŸ
- [ ] è§£æãŒå®Œäº†ã—ã€çµæœãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] å™¨å…·é¸æŠã¨è¿½è·¡ãŒå‹•ä½œã™ã‚‹

### æœ€çµ‚ï¼ˆPhase 5å®Œäº†æ™‚ï¼‰:
- [ ] E2Eãƒ†ã‚¹ãƒˆå…¨ã¦ãƒ‘ã‚¹
- [ ] ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æ—§å®Ÿè£…ãŒå®Œå…¨å‰Šé™¤
- [ ] ãƒ­ã‚°ãŒæ˜ç¢ºã§è¿½è·¡å¯èƒ½
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæœ€æ–°ã®å®Ÿè£…ã‚’åæ˜ 

---

## âš ï¸ ãƒªã‚¹ã‚¯ã¨å¯¾ç­–

| ãƒªã‚¹ã‚¯ | å¯¾ç­– |
|--------|------|
| V2ãŒå…¨æ©Ÿèƒ½ã‚’ã‚«ãƒãƒ¼ã—ã¦ã„ãªã„ | Phase 0ã§å¾¹åº•ç¢ºèªã€å•é¡Œã‚ã‚Œã°ç§»è¡Œã‚’ä¸­æ­¢ |
| å‰Šé™¤å¾Œã«æœªçŸ¥ã®ä¾å­˜é–¢ä¿‚ãŒç™ºè¦š | å„Phaseã§ãƒ†ã‚¹ãƒˆã€å•é¡Œã‚ã‚Œã°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹ | Phase 5ã§ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã€å•é¡Œã‚ã‚Œã°æœ€é©åŒ– |
| æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å½±éŸ¿ | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹äº’æ›æ€§ç¢ºä¿ã€æ®µéšçš„ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ |

---

## ğŸ“ å®Ÿè¡Œãƒ­ã‚°

### Phase 0: å®‰å…¨ç¢ºèª
- **é–‹å§‹**: 2025-10-05 02:30 JST
- **çµæœ**: âœ… å®Œäº†
  - Lock fileãƒ¡ã‚«ãƒ‹ã‚ºãƒ å®Ÿè£… (PID: 34584)
  - éª¨æ ¼æ¤œå‡ºä¿®æ­£: `skeleton_detector.py`ã«`detected`ã‚­ãƒ¼è¿½åŠ 
  - è§£ææˆåŠŸ: 292ãƒ•ãƒ¬ãƒ¼ãƒ æ¤œå‡º (Analysis ID: 3493e268-6b94-471b-b21b-fe95f2a6cc59)
  - è¤‡æ•°ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å•é¡Œè§£æ±º

### Phase 1: V2ç§»è¡Œç¢ºèª
- **é–‹å§‹**: 2025-10-05 03:00 JST
- **çµæœ**: âœ… å®Œäº†
  - `process_with_mediapipe`é–¢æ•°: DEPRECATEDåŒ–ç¢ºèª (Line 439)
  - å‘¼ã³å‡ºã—å…ƒ: ãªã—ï¼ˆV2ãŒä½¿ç”¨ä¸­ï¼‰
  - SAM Tracker: `videos.py`ã§ä½¿ç”¨ä¸­ï¼ˆå™¨å…·é¸æŠç”¨ï¼‰â†’ ä¿æŒ

### Phase 2: ãƒ¬ã‚¬ã‚·ãƒ¼å‰Šé™¤
- **é–‹å§‹**: 2025-10-05 03:10 JST
- **çµæœ**: âœ… å®Œäº†
  - å‰Šé™¤: Line 438-1122 (685è¡Œå‰Šé™¤)
  - å‰Šé™¤å¯¾è±¡:
    - `process_with_mediapipe_DEPRECATED()` (Line 439-793)
    - `sync_process_with_mock_enhanced_DEPRECATED()` (Line 794-940)
    - `sync_process_with_mock_DEPRECATED()` (Line 941-948)
    - `process_with_mock_DEPRECATED()` (Line 951-1122)
  - ã‚³ãƒ¼ãƒ‰å‰Šæ¸›: 1,291è¡Œ â†’ 606è¡Œ (53%å‰Šæ¸›)
  - ã‚µãƒ¼ãƒãƒ¼æ­£å¸¸ç¨¼åƒç¢ºèª

### Phase 3: ãƒ†ã‚¹ãƒˆæ•´ç†
- **é–‹å§‹**: 2025-10-05 03:15 JST
- **çµæœ**: âœ… å®Œäº†
  - `tests/legacy/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
  - ç§»å‹•: 16ãƒ•ã‚¡ã‚¤ãƒ« â†’ `tests/legacy/`
  - ãƒªãƒãƒ¼ãƒ :
    - `test_sam_auto_detect.py` â†’ `tests/test_sam_unified.py`
    - `test_mediapipe_direct.py` â†’ `tests/test_mediapipe.py`
  - ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: test_*.pyå®Œå…¨å‰Šé™¤

### Phase 4: æœ€çµ‚ç°¡ç´ åŒ–
- **é–‹å§‹**: 2025-10-05 03:20 JST
- **çµæœ**: âœ… å®Œäº†
  - ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸çµ±ä¸€: `[V2]` â†’ `[ANALYSIS]` (88ç®‡æ‰€)
    - `analysis_service_v2.py`: 79ç®‡æ‰€
    - `analysis.py`: 9ç®‡æ‰€
  - ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ•´ç†: æœªä½¿ç”¨ãªã—
  - SAM Tracker: `videos.py`ã§ä½¿ç”¨ä¸­ï¼ˆå‰Šé™¤ä¸å¯ï¼‰

### Phase 5: æœ€çµ‚æ¤œè¨¼
- **é–‹å§‹**: [æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚º]
- **çµæœ**: [å®Ÿè¡Œå¾…ã¡]
